---
title: "AD GSEA Script"
author: "Alexander Bergendorf"
date: "2023-09-10"
output: html_document
---

# Library Import
```{r}
library(fgsea)
library(Seurat)
library(mixOmics)
library(tidyverse)
library(orthogene)
library(dittoSeq)
library(openxlsx)
library(EnrichmentBrowser)
library(qusage)
library(ggpubr)
home_dir <- "C:/Users/aberg/OneDrive/Desktop/Brubaker Summer Research 2023"
```


# PCA
## Data Import
```{r}
combined <- readRDS(file = paste0(home_dir, "/AD_mouse_objects_ortholog/mouse_pca_loadings.RData"))
```


## Running Ranked GSEA Analysis on C2:KEGG
```{r}
gene_set <- read.gmt(file = paste0(home_dir, "/c2.cp.kegg.v2023.1.Hs.symbols.gmt"))
mouse_loadings <- combined@reductions$pca@feature.loadings
ortholog_mat <- convert_orthologs(gene_df = row.names(mouse_loadings),
                                    input_species = "mouse",
                                    output_species = "human",
                                    non121_strategy = "drop_both_species")
mouse_loadings <- mouse_loadings[ortholog_mat$input_gene,]
row.names(mouse_loadings) <- row.names(ortholog_mat)

ortholog_mat
fgsea_list <- list()

for(i in 1:2){
  pc_vec <- as.numeric(mouse_loadings[,i])
  pc_vec <- sort(pc_vec, decreasing = TRUE)
  names(pc_vec) <- row.names(mouse_loadings)

  fgsea_list[[i]] <- fgsea(pathways = gene_set,
                   stats = pc_vec)
}
```



```{r}
names(fgsea_list) <- c("pca_1", "pca_2", "pca_3", "pca_4", "pca_5",
                       "pca_6", "pca_7", "pca_8", "pca_9", "pca_10",
                       "pca_11", "pca_12", "pca_13", "pca_14", "pca_15",
                       "pca_16", "pca_17", "pca_18", "pca_19", "pca_20",
                       "pca_21", "pca_22", "pca_23", "pca_24", "pca_25",
                       "pca_26", "pca_27", "pca_28", "pca_29", "pca_30",
                       "pca_31", "pca_32", "pca_33", "pca_34", "pca_35",
                       "pca_36", "pca_37", "pca_38", "pca_39", "pca_40",
                       "pca_41", "pca_42", "pca_43", "pca_44", "pca_45",
                       "pca_46", "pca_47", "pca_48", "pca_49", "pca_50")



for(i in names(fgsea_list)){ 
  fgsea_list[[i]] <- arrange(fgsea_list[[i]], padj)

} 

write.xlsx(fgsea_list, file = paste0(home_dir, "/fgsea_results.xlsx"))
```

### Exploring 
```{r}
read.xlsx(fgsea_list, file = paste0(home_dir, "/fgsea_results"))
```


## Running Ranked GSEA Analysis on C7
```{r}
gene_set <- read.gmt(file = paste0(home_dir, "/c7.immunesigdb.v2023.1.Hs.symbols.gmt"))
mouse_loadings <- combined@reductions$pca@feature.loadings
ortholog_mat <- convert_orthologs(gene_df = row.names(mouse_loadings),
                                    input_species = "mouse",
                                    output_species = "human",
                                    non121_strategy = "drop_both_species")
mouse_loadings <- mouse_loadings[ortholog_mat$input_gene,]
row.names(mouse_loadings) <- row.names(ortholog_mat)

ortholog_mat
fgsea_list <- list()

for(i in 1:50){
  pc_vec <- as.numeric(mouse_loadings[,i])
  pc_vec <- sort(pc_vec, decreasing = TRUE)
  names(pc_vec) <- row.names(mouse_loadings)

  fgsea_list[[i]] <- fgsea(pathways = gene_set,
                   stats = pc_vec)
}
```

```{r}
names(fgsea_list) <- c("pca_1", "pca_2", "pca_3", "pca_4", "pca_5",
                       "pca_6", "pca_7", "pca_8", "pca_9", "pca_10",
                       "pca_11", "pca_12", "pca_13", "pca_14", "pca_15",
                       "pca_16", "pca_17", "pca_18", "pca_19", "pca_20",
                       "pca_21", "pca_22", "pca_23", "pca_24", "pca_25",
                       "pca_26", "pca_27", "pca_28", "pca_29", "pca_30",
                       "pca_31", "pca_32", "pca_33", "pca_34", "pca_35",
                       "pca_36", "pca_37", "pca_38", "pca_39", "pca_40",
                       "pca_41", "pca_42", "pca_43", "pca_44", "pca_45",
                       "pca_46", "pca_47", "pca_48", "pca_49", "pca_50")



for(i in names(fgsea_list)){ 
  fgsea_list[[i]] <- arrange(fgsea_list[[i]], padj)

} 

write.xlsx(fgsea_list, file = paste0(home_dir, "/fgsea_results_c7.xlsx"))
```


# Isolating AD Vector
```{r}
ad_vector <- fgsea_list[[1]] %>%
    filter(pathway == "KEGG_ALZHEIMERS_DISEASE")
  
for(i in 2:50){
  ad_row <- fgsea_list[[i]] %>%
    filter(pathway == "KEGG_ALZHEIMERS_DISEASE")
  ad_vector <- rbind(ad_vector, ad_row)
}
ad_vector <- cbind(ad_vector, PC = c(1:50))
ad_vector <- ad_vector %>%
  arrange(padj)
ad_vector
```


# sPCA
## Data Import
```{r}
combined <- readRDS(file = paste0(home_dir, "/AD_mouse_objects_ortholog/mouse_spca_loadings.RData"))
```



```{r}
gene_set <- read.gmt(file = paste0(home_dir, "/c7.immunesigdb.v2023.1.Hs.symbols.gmt"))

mouse_loadings <- combined@reductions$spca@feature.loadings
ortholog_mat <- convert_orthologs(gene_df = row.names(mouse_loadings),
                                    input_species = "mouse",
                                    output_species = "human",
                                    non121_strategy = "drop_both_species")
mouse_loadings <- mouse_loadings[ortholog_mat$input_gene,]
row.names(mouse_loadings) <- row.names(ortholog_mat)

fgsea_list <- list()

for(i in 1:2){
  pc_vec <- as.numeric(mouse_loadings[,i])
  pc_vec <- sort(pc_vec, decreasing = TRUE)
  names(pc_vec) <- row.names(mouse_loadings)

  fgsea_list[[i]] <- fgsea(pathways = gene_set,
                   stats = pc_vec)
  
  pathway_up <- fgsea_list[[i]] %>%
    filter(ES > 0) %>%
    arrange(pval) %>%
    head(n = 10)

  pathway_down <- fgsea_list[[i]] %>%
    filter(ES < 0) %>%
    arrange(pval) %>%
    head(n = 10)



  pdf(paste0(home_dir, "/c7gseatable_spca", i,".pdf"), width = 13.5)

  plotGseaTable(gene_set[c(pathway_up$pathway, pathway_down$pathway)], stats = pc_vec, fgseaRes = fgsea_list[[i]],
                colwidths = c(8.5, 2, 1, 1, 1))
}
```



```{r}
pathway_up <- fgsea_list[[2]] %>%
  filter(ES > 0) %>%
  arrange(pval) %>%
  head(n = 10)

pathway_down <- fgsea_list[[2]] %>%
  filter(ES < 0) %>%
  arrange(pval) %>%
  head(n = 10)



pdf(paste0(home_dir, "/testgseatable.pdf"))

plotGseaTable(gene_set[c(pathway_up$pathway, pathway_down$pathway)], stats = pc_vec, fgseaRes = fgsea_list[[2]])
```



# Test
```{r}
gene_set <- read.gmt(file = paste0(home_dir, "/c7.immunesigdb.v2023.1.Hs.symbols.gmt"))

mouse_loadings <- combined@reductions$pca@feature.loadings
ortholog_mat <- convert_orthologs(gene_df = row.names(mouse_loadings),
                                    input_species = "mouse",
                                    output_species = "human",
                                    non121_strategy = "drop_both_species")
mouse_loadings <- mouse_loadings[ortholog_mat$input_gene,]
row.names(mouse_loadings) <- row.names(ortholog_mat)

ortholog_mat
fgsea_list <- list()

for(i in 1:2){
  pc_vec <- as.numeric(mouse_loadings[,i])
  pc_vec <- sort(pc_vec, decreasing = TRUE)
  names(pc_vec) <- row.names(mouse_loadings)

  fgsea_list[[i]] <- fgsea(pathways = gene_set,
                   stats = pc_vec)
  
  pathway_up <- fgsea_list[[i]] %>%
    filter(ES > 0) %>%
    arrange(pval) %>%
    head(n = 10)

  pathway_down <- fgsea_list[[i]] %>%
    filter(ES < 0) %>%
    arrange(pval) %>%
    head(n = 10)



  pdf(paste0(home_dir, "/c7gseatable_", i,".pdf"), width = 13)

  plotGseaTable(gene_set[c(pathway_up$pathway, pathway_down$pathway)], stats = pc_vec, fgseaRes = fgsea_list[[i]],
                colwidths = c(8, 2, 1, 1, 1))
}
```

